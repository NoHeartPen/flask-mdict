{% extends "layout.html" %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="{{url_for('.static', filename='css/typeahead.css')}}">
{% endblock %}

{% block subtitle %}MDict - {{word}}{% endblock %}

{% block maincontent %}
<div class="row">
    <div class="col-3">
        <div class="sticky-top">
            <div style="padding-top: 60px; margin-top: -60px;"> </div>
            <form method="POST">
                <div class="input-group">
                    {{ form.word(placeholder='word', class='form-control', autocomplete='off') }}
                    <div class="input-group-append">
                        <button id="btn-search" type="submit" class="btn btn-outline-info">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                {{ form.csrf_token }}
            </form>
            <br />
            <ul class="list-group">
                {% for name, item in contents.items() %}
                <li class="list-group-item">
                    <a href="#{{name}}">{{item.title}}</a>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <div class="col">
        <div id="top" style="padding-top: 60px; margin-top: -60px;"> </div>
        {% for name, item in contents.items() %}
        <div id="{{name}}" style="padding-top: 60px; margin-top: -60px;"> </div>
        <div class="card">
            <div class="card-header">
                <div class="row align-items-center">
                    <div class="col-md-10">
                        <button class="btn btn-link py-0"
                                data-toggle="collapse"
                                data-target="#collapse_{{name}}">
                            {{item.title}}
                        </button>
                    </div>
                    <div class="col-md-2">
                        <a class="float-right" href="#top">Back to top</a>
                    </div>
                </div>
            </div>
            <div id="collapse_{{name}}" class="collapse{%if item.content%} show{%endif%}">
                <div class="card-body">
                    {{item.content|join|safe}}
                </div>
            </div>
        </div>
        <br />
        {% endfor %}
    </div>
</div>
{% endblock %}
{% block script %}
<script src="{{url_for(".static", filename="js/typeahead.bundle.min.js")}}"></script>
<script type="text/javascript">
    player = document.createElement("audio");
player.id = 'player';

function play(url) {
    player.src = url;
    player.play();
}

function makefunction(url)
{
    return function (e) {
        play(url);
        e.preventDefault();
    }
}

/* fix all link in content. */
var all_a = document.getElementsByTagName('a');
for (i in all_a) {
    var item = all_a[i]
    if (item.href && item.href.lastIndexOf("sound://", 0) === 0) {
        var url = item.href.replace("sound://", "");
        var func = makefunction(url);
        item.addEventListener("click", func);
    }

    if (item.href && item.href.lastIndexOf("entry://", 0) === 0) {
        item.href = item.href.replace("entry://", "")
    }
}
/* typeahead */
var dataset_engine = new Bloodhound({
    queryTokenizer: Bloodhound.tokenizers.whitespace,
    datumTokenizer: Bloodhound.tokenizers.whitespace,
    remote: {
        url: '{{url_for('.query_part', part='')}}' + '%QUERY',
        wildcard: '%QUERY',
        transform: function(data){
            return data.suggestion;
        }
    }
});
$('#word').typeahead({
    minLength: 2,
    highlight: true
},
{
    name: 'suggestion',
    limit: 10,
    source: dataset_engine,
    display: function(data) {
        return data;
    }
});
</script>
{% endblock %}
